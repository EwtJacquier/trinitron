<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CRT Camera Viewer</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: black;
      color: white;
      font-family: sans-serif;
    }
    #settings {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.8);
      padding: 20px;
      border-radius: 10px;
      z-index: 10;
    }
    label, select, button {
      display: block;
      margin: 10px 0;
    }
    canvas {
      position: absolute;
      top: 0;
      left: 0;
    }
    video, audio {
      display: none;
    }
  </style>
</head>
<body>
  <div id="settings">
    <label for="videoSource">Select Camera:</label>
    <select id="videoSource"></select>

    <label for="audioSource">Select Microphone:</label>
    <select id="audioSource"></select>

    <button id="startButton">Confirm</button>
  </div>

  <video id="video" autoplay playsinline></video>
  <audio id="audio" autoplay controls></audio>
  <canvas id="canvas"></canvas>

  <script>
    const videoElement = document.getElementById('video');
    const audioElement = document.getElementById('audio');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const videoSelect = document.getElementById('videoSource');
    const audioSelect = document.getElementById('audioSource');
    const startButton = document.getElementById('startButton');
    const settings = document.getElementById('settings');

    // Resize canvas to full screen
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // Get device list
    async function getDevices() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      videoSelect.innerHTML = '';
      audioSelect.innerHTML = '';

      devices.forEach(device => {
        const option = document.createElement('option');
        option.value = device.deviceId;
        option.text = device.label || `${device.kind}`;
        if (device.kind === 'videoinput') {
          videoSelect.appendChild(option);
        } else if (device.kind === 'audioinput') {
          audioSelect.appendChild(option);
        }
      });
    }

    // Get stream based on selections
    async function startStream() {
      const videoId = videoSelect.value;
      const audioId = audioSelect.value;

      const constraints = {
        video: {
          deviceId: videoId ? { exact: videoId } : undefined,
          frameRate: { ideal: 60 },
          width: { ideal: 1280 },
          height: { ideal: 720 }
        },
        audio: {
          deviceId: audioId ? { exact: audioId } : undefined
        }
      };

      try {
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        videoElement.srcObject = stream;
        audioElement.srcObject = stream;
        settings.style.display = 'none'; // hide menu
        renderLoop();
      } catch (err) {
        alert('Error accessing devices: ' + err.message);
        console.error(err);
      }
    }

    // Draw video with CRT effect
    function renderLoop() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);

      // Apply CRT effect (scanlines + slight RGB shift)
      let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      let data = imageData.data;

      for (let y = 0; y < canvas.height; y++) {
        if (y % 2 === 0) {
          for (let x = 0; x < canvas.width; x++) {
            let i = (y * canvas.width + x) * 4;
            data[i] *= 0.9;     // Red
            data[i + 1] *= 0.9; // Green
            data[i + 2] *= 1.2; // Blue boost
          }
        }
      }

      ctx.putImageData(imageData, 0, 0);

      requestAnimationFrame(renderLoop);
    }

    // Populate devices list on load
    navigator.mediaDevices.getUserMedia({ audio: true, video: true })
      .then(stream => {
        stream.getTracks().forEach(track => track.stop());
        return getDevices();
      });

    startButton.addEventListener('click', startStream);
  </script>
</body>
</html>
